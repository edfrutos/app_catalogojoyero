<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Catálogo Tablas - Gestión de Productos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" />
  </head>
  <body>
    <div class="container">
      <!-- Botón de Cerrar Sesión -->
      {% if session.usuario %}
      <div style="float: right">
        <button type="button" class="btn-secondary mt-1" onclick="window.location.href='/logout'">
          Cerrar Sesión ({{ session.usuario }})
        </button>
      </div>
      {% endif %}

      <header>
        <h1>Catálogo de Tablas (Popup de Imágenes)</h1>
      </header>

      <!-- Opciones de tabla -->
      <div style="margin-bottom: 1rem">
        <button type="button" onclick="window.location.href='/tables'" class="btn-secondary mt-2">
          Opciones de Tabla
        </button>
      </div>

      <!-- Mensajes de error o éxito -->
      {% if error_message %}
      <p class="error-message">{{ error_message }}</p>
      {% elif success_message %}
      <p class="success-message">{{ success_message }}</p>
      {% endif %}

      <!-- Descargar Excel -->
      <div style="margin-bottom: 1rem">
        <a class="download-link" href="/descargar-excel">Descargar Excel (datos.xlsx)</a>
      </div>

      <!-- Formulario para agregar nuevo registro -->
      <section id="formulario-agregar">
        <h2>Agregar Nuevo Registro</h2>
        <form method="POST" enctype="multipart/form-data">
          {% for header in session["selected_headers"] %} {% if header.lower() != "imagenes" %}
          <label for="{{ header }}">{{ header }}:</label>
          <input type="text" name="{{ header }}" placeholder="Introduce {{ header }}" />
          {% endif %} {% endfor %}

          <label for="imagenes">Imágenes (hasta 3):</label>
          <input type="file" name="imagenes" multiple />

          <button type="submit" class="btn">Agregar</button>
        </form>
      </section>

      <!-- Instrucciones -->
      <section id="instrucciones">
        <h2>Instrucciones para el Catálogo</h2>
        <ul>
          <li><strong>Agregar Registro:</strong> Completa el formulario y asegúrate de que el "Número" sea único.</li>
          <li><strong>Descargar Excel:</strong> Usa el enlace "Descargar Excel" para obtener el archivo ZIP.</li>
          <li><strong>Editar Registros:</strong> Haz clic en "Editar" en la columna de acciones.</li>
          <li><strong>Visualización de Imágenes:</strong> Haz clic en una miniatura para ampliar.</li>
          <li><strong>Opciones de Tabla:</strong> Crea o importa nuevas hojas de cálculo.</li>
        </ul>
      </section>

      <!-- Tabla de registros -->
      <section id="tabla-registros">
        <h2>Listado de Registros</h2>
        <table>
          <thead>
            <tr>
              {% for header in session["selected_headers"] %}
              <th>{{ header }}</th>
              {% endfor %}
              <th>Imágenes</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for item in data %}
            <tr>
              {% for header in session["selected_headers"] %}
              <td>{{ item.get(header, '') }}</td>
              {% endfor %}
              <td>
                {% for ruta in item.get("imagenes", []) %} {% if ruta %}
                <img
                  src="{{ url_for('uploaded_images', filename=ruta.split('/')[-1]) }}"
                  alt="Preview"
                  class="thumbnail"
                  onclick="showModal(this.src)"
                />
                {% endif %} {% endfor %}
              </td>
              <td>
                {% if item.get("Número") %}
                <a href="/editar/{{ item.get('Número') }}">Editar</a>
                {% else %}
                <span class="error-text">Error: Sin número</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>
    </div>

    <!-- Modal para imágenes -->
    <div id="imageModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <img id="modalImage" src="" alt="Imagen ampliada" />
      </div>
    </div>

    <script>
      function showModal(imageSrc) {
        document.getElementById('modalImage').src = imageSrc;
        document.getElementById('imageModal').style.display = 'block';
      }
      function closeModal() {
        document.getElementById('imageModal').style.display = 'none';
      }
      window.onclick = function (event) {
        if (event.target === document.getElementById('imageModal')) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
